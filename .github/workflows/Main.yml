name: Run Java Program on EC2 via SSM with Slack Notifications

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Set up AWS CLI
      run: |
        sudo apt-get update
        sudo apt-get install -y awscli

    - name: Configure AWS Credentials
      env:
        AWS_ACCESS_KEY_ID: AKIASOWTJBGDMO75WC5Z
        AWS_SECRET_ACCESS_KEY: 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
      run: |
        aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
        aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
        aws configure set region us-east-1

    - name: Run Java Program on EC2 via SSM
      id: ssm-command
      run: |
        RESPONSE=$(aws ssm send-command \
        --document-name "AWS-RunShellScript" \
        --targets "Key=instanceids,Values=i-0ad49eaf9e2b7c431" \
        --parameters '{"commands":["cd /home/ubuntu/java-repo", "javac Main.java", "java Main"]}' \
        --comment "Running Java Program via SSM" \
        --region us-east-1 \
        --query "Command.CommandId" \
        --output text)
        echo "SSM Command ID: $RESPONSE"
        echo "command_id=$RESPONSE" >> $GITHUB_ENV

    - name: Notify Slack on Success
      if: success()
      run: |
        curl -X POST -H 'Content-Type: application/json' \
        -H "Authorization: Bearer RHCDXUctAk5h45KrqueVsX31" \
        --data '{"channel": "'"D07N7BRADJ4'"', "text": "Java Program Execution on EC2 via SSM Succeeded :white_check_mark: \nInstance ID: '"i-0ad49eaf9e2b7c431"' \nOutput: Program executed successfully!"}' \
        https://slack.com/api/chat.postMessage

    - name: Notify Slack on Failure
      if: failure()
      run: |
        command_id=${{ env.command_id }}
        echo "Command execution failed. Attempting to retrieve logs..."
        logs=$(aws ssm list-command-invocations --command-id $command_id --details --query "CommandInvocations[0].CommandPlugins[0].Output" --output text || echo "Unable to retrieve logs.")
        curl -X POST -H 'Content-Type: application/json' \
        -H "Authorization: Bearer RHCDXUctAk5h45KrqueVsX31" \
        --data '{"channel": "'"D07N7BRADJ4'"', "text": "Java Program Execution on EC2 via SSM Failed :x: \nInstance ID: '"i-0ad49eaf9e2b7c431"' \nLogs: '"$logs"'"}' \
        https://slack.com/api/chat.postMessage
        
